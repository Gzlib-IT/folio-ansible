---
# Ansible playbook to deploy Okapi and FOLIO modules
# Provision a host as a backend FOLIO system
- hosts: folio-backend
  roles:
    - common
    - postgresql
    - okapi
    - okapi-deploy-modules

# split these roles so that the "Rebuild stripes" handler is only
# called once
- hosts: snapshot
  roles:
    - common
    - postgresql
    - okapi
    - okapi-deploy-config

- hosts: snapshot-part2
  roles:
    - create-tenant-admin
    - tenant-admin-permissions
    - stripes-docker

# Provision a host with the sample tenant and data
- hosts: folio-sample-data-stable
  roles:
    - enable-tenant-modules
    - deprecated/mod-auth-data
    - deprecated/mod-inventory-data
    - mod-circulation-data
    - mod-auth-demo-users

# Provision a host with the sample tenant and data
- name: Set up tenant for sample data
  hosts: folio-sample-data-testing
  roles:
    - enable-tenant-modules
    - create-tenant-admin
    - tenant-admin-permissions

- name: Load inventory data
  hosts: folio-sample-data-testing
  roles:
    - role: module-sample-data
      module_name: mod-inventory-storage
      repository: "https://github.com/folio-org/mod-inventory-storage"
      module_version: FOLIO-1313-align-data
      duplicate_key_error: 400
      files:
        - { load_endpoint: /classification-types, fileglob: reference-data/classification-types/*.json }
        - { load_endpoint: /contributor-name-types, fileglob: reference-data/contributor-name-types/*.json }
        - { load_endpoint: /contributor-types, fileglob: reference-data/contributor-types/*.json }
        - { load_endpoint: /identifier-types, fileglob: reference-data/identifier-types/*.json }
        - { load_endpoint: /instance-formats, fileglob: reference-data/instance-formats/*.json }
        - { load_endpoint: /instance-types, fileglob: reference-data/instance-types/*.json }
        - { load_endpoint: /loan-types, fileglob: reference-data/loan-types/*.json }
        - { load_endpoint: /location-units/institutions, fileglob: reference-data/location-units/institutions/*.json, dup_override: 422 }
        - { load_endpoint: /location-units/campuses, fileglob: reference-data/location-units/campuses/*.json, dup_override: 422 }
        - { load_endpoint: /location-units/libraries, fileglob: reference-data/location-units/libraries/*.json,  dup_override: 422 }
        - { load_endpoint: /locations, fileglob: reference-data/locations/*.json, dup_override: 422 }
        - { load_endpoint: /material-types, fileglob: reference-data/material-types/*.json, dup_override: 422 }
        - { load_endpoint: /platforms, fileglob: reference-data/platforms/*.json }
        - { load_endpoint: /service-points, fileglob: reference-data/service-points/*.json, dup_override: 422 }
        - { load_endpoint: /instance-storage/instances, fileglob: sample-data/instances/*.json }
        - { load_endpoint: /instance-storage/instances, fileglob: sample-data/instances/*.json }
        - { load_endpoint: /holdings-storage/holdings, fileglob: sample-data/holdingsrecords/*.json }
        - { load_endpoint: /item-storage/items, fileglob: sample-data/items/*.json }

- name: Load MODS data
  hosts: folio-sample-data-testing
  roles:
    - mod-inventory-mods

- name: Load circulation data
  hosts: folio-sample-data-testing
  roles:
    - mod-circulation-data

- name: Load vendors
  hosts: folio-sample-data-testing
  roles:
    - role: module-sample-data
      module_name: mod-vendors
      repository: "https://github.com/folio-org/mod-vendors"
      load_endpoint: /vendor
      fileglob:
        - sample-data/vendors/*.json

- name: Create demo users
  hosts: folio-sample-data-testing
  roles:
    - mod-auth-demo-users

# Provision a host with the sample tenant and data
- hosts: folio-sample-data-snapshot
  vars_files:
    - group_vars/snapshot
  roles:
    - deprecated/mod-inventory-data
    - mod-circulation-data
    - role: module-sample-data
      module_name: mod-vendors
      repository: "https://github.com/folio-org/mod-vendors"
      files:
        - { load_endpoint: /vendor, fileglob: sample-data/vendors/*.json }
    - mod-auth-demo-users

# Provision a host with a Stripes build
# Post module descriptors to Okapi
- hosts: stripes-build
  roles:
    - stripes-build
    - tenant-admin-permissions

# Provision a host as a Stripes server
- hosts: stripes
  roles:
    - stripes-docker
    - tenant-admin-permissions

# Roles for packaging
- hosts: vagrant
  roles:
    - maven-3

- hosts: packer
  roles:
    - vagrant-tidy

# Provision a host to support FOLIO Developer Curriculum
- hosts: build_curriculum
  roles:
    - common
    - openjdk-8
    - maven-3
    - nodejs
    - yarn
    - ansible
    - docker-engine

  tasks:
    - name: Move to Node.js 6.X lts
      become: yes
      shell: n lts && touch /etc/.set_nodedefault_ansible
      args:
        creates: /etc/.set_nodedefault_ansible

    - name: Setup Ansible inventory for localhost
      become: yes
      lineinfile:
        dest: /etc/ansible/hosts
        line: localhost ansible_connection=local

    - name: Clone curriculum repository
      git: repo=https://github.com/folio-org/curriculum dest={{ ansible_env.HOME }}/curriculum

