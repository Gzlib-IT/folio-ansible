---
# see https://github.com/library-data-platform/ldp/blob/master/doc/Admin_Guide.md
# use create-database role to make admin user, and assign role to pg admin user if RDS

# create additional config and ldp users
- name: Create ldpconfig user for {{ tenant }}
  debug: msg="run"
  when: not server_only

- name: Create ldp user for {{ tenant }}
  debug: msg="run"
  when: not server_only

# assign perms for additional users
- name: GRANT USAGE ON SCHEMA public TO {{ ldpconfig_user }}
  debug: msg="run"
  when: not server_only

- name: GRANT USAGE ON SCHEMA public TO {{ ldp_user }}
  debug: msg="run"
  when: not server_only

- name: Create directory for ini files
  debug: msg="run"

- name: template odbc.ini
  debug: msg="run"

- name: template odbcinst.ini
  debug: msg="run"

- name: Create directory ldp data dir
  debug: msg="run"

- name: template ldpconf.json
  debug: msg="run"

- name: test if init has already been run
  debug: msg="run"
  when: not server_only

- set_fact:
    result: False

- name: run ldp init
  debug: msg="run"
  when: not result and not server_only

- name: pause for init container
  debug: msg="run"
  when: not result and not server_only

- name: run ldp server
  debug: msg="run"
  register: server_result
  when: not init_only
