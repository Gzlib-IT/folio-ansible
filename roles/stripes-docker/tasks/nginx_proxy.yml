---

- name: create docker build dir
  become: yes
  file: 
    path: "{{ stripes_conf_dir }}/nginx_proxy"
    state: directory

- name: copy nginx conf to build dir
  become: yes
  template: 
    src: "{{ item.src }}"
    dest: "{{ stripes_conf_dir }}/nginx_proxy/{{ item.dest }}"
  with_items: 
    - { src: 'stripes.conf.j2', dest: 'stripes.conf' }

- name: copy Dockerfile to nginx build dir
  become: yes
  copy: 
    src: Dockerfile.proxy
    dest: "{{ stripes_conf_dir }}/nginx_proxy/Dockerfile"

- name: build and start nginx stripes proxy docker container
  become: yes
  docker_service:
    project_name: stripes_nginx_proxy
    definition:
      version: '2'
      services: 
        stripes_nginx_proxy:
          build: "{{ stripes_conf_dir }}/nginx_proxy"
          image: stripes_nginx_proxy
          ports:
            - "{{ nginx_proxy_port }}:80"
          networks:
            stripes-net:
          restart: always
      networks:
        stripes-net:
          external: true
    state: present
  register: stripes_nginx_proxy_container_status

- debug:
    var: stripes_nginx_proxy_container_status
